# MultiChain Docker (local dev / test)

Lightweight Docker configuration and helper scripts to run a MultiChain masternode, explorer and peer nodes for local development and smoke testing.

## Contents
- Quick start
- What’s in this repo
- Configuration (`.env`)
- Helper scripts
- Build & run (Docker Compose)
- Ports
- Troubleshooting & notes
- License

## Quick start
1. Copy the example environment and edit values:
   - `cp .env.example .env`
2. Use the interactive helper to generate secure RPC credentials and start services:
   - On Linux / WSL / Git Bash:
     - `./scripts/setup.sh`
   - For non-interactive or CI:
     - `./scripts/setup.sh --yes`
3. Or start manually:
   - `docker compose up -d`

See the Compose configuration at `docker-compose.yaml` for service and volume details.

## What’s in this repo
- Base image and helpers:
  - `base/Dockerfile`, `base/entrypoint.sh`, `base/mc-common.sh`
- Role images:
  - Master (creator) node: `master/Dockerfile`, `master/entrypoint.sh`
  - Peers (joiners): `node/Dockerfile`, `node/connect-node.sh`
  - Explorer: `explorer/Dockerfile`, `explorer/run-services.sh`
- Compose orchestration:
  - `docker-compose.yaml`
- Helpers & health:
  - `scripts/setup.sh` — interactive `.env` generator + start/reset helpers
  - `scripts/smoke-test.sh` — bring up stack, basic connectivity checks and teardown
  - `scripts/healthcheck_rpc.sh` — masternode health probe used by Compose

## Configuration (.env)
- Copy `.env.example` and edit (or let `scripts/setup.sh` generate values):
  - `CHAIN_NAME` — chain identifier
  - `RPC_USER` / `RPC_PASSWORD` — RPC credentials (auto-generated by `setup.sh` if omitted)
  - `MASTER_PORT` / `RPC_PORT` — masternode P2P and RPC ports
  - `RPC_HOST` / `RPC_ALLOWIP` — networking for explorer/host access

## Helper scripts
- `scripts/setup.sh`
  - Interactive `.env` creation, optional reset (`--reset`), choose services (`--services core|all`), skip start (`--no-start`).
  - Uses Docker Compose and validates prerequisites.
- `scripts/smoke-test.sh`
  - Quick verification that masternode becomes healthy, peers connect, and explorer serves content.
- `scripts/healthcheck_rpc.sh`
  - Healthcheck used inside the master container to assert RPC responds.

## Setup using `scripts/setup.sh`
The repository includes an interactive helper at `scripts/setup.sh` that creates a secure `.env`, optionally resets the compose resources, and starts the stack. The script is a POSIX shell script — run it from WSL, Git Bash, or any POSIX-compatible shell.

Main behaviors:
- Interactive mode (default): prompts for values and writes `.env` with mode 600.
- Non-interactive mode (`--yes`): accept sensible defaults and overwrite existing `.env`.
- `--no-start`: write `.env` but don't start Docker Compose.
- `--reset`: destructive cleanup of containers, named volumes and images for the compose project before starting.
- `--services core|all`: choose to start only core (masternode + explorer) or all services (including peers).
- `--env local|prod`: choose environment defaults; `local` makes RPC host accessible for browser testing, `prod` uses tighter defaults.

Examples

Run interactively (recommended for first-time setup) from WSL or Git Bash:

```bash
./scripts/setup.sh
```

Run non-interactively (CI or scripted runs) and start services:

```bash
./scripts/setup.sh --yes
```

Create `.env` but do not start services:

```bash
./scripts/setup.sh --no-start
```

Reset (destructive) and start only core services:

```bash
./scripts/setup.sh --reset --services core
```

Windows (PowerShell) notes
- Because `scripts/setup.sh` is a bash script, run it from WSL2 or Git Bash for best results. From PowerShell you can invoke WSL:

```powershell
wsl ./scripts/setup.sh
```

Or open Git Bash and run:

```bash
./scripts/setup.sh
```

Important notes
- The script sets file mode `600` on `.env` to keep RPC credentials private. On Windows filesystems this permission may be ignored — keep the `.env` secure.
- The script requires `docker` and either `docker compose` or `docker-compose` to be available in PATH.
- If you want to provide values non-interactively but without `--yes`, export variables before invoking the script, for example:

```bash
export RPC_PASSWORD="mysecurepw" RPC_USER="multichainrpc" && ./scripts/setup.sh --no-start
```

After running the script and starting services, the script prints compose status and recent logs for `masternode` and `explorer` to help diagnose startup issues.

## Build & run (Docker Compose)
- Build + start (default: all services — masternode, explorer, peers):
  - `docker compose up -d`
- Start only core (masternode + explorer):
  - `docker compose up -d masternode explorer`
- Rebuild images:
  - `docker compose build --no-cache`
- Tear down and remove volumes/images (destructive):
  - `docker compose down --rmi all --volumes --remove-orphans`

## Windows notes
- The repository's helper scripts assume a POSIX shell. On Windows use WSL2, Git Bash, or run scripts from the Docker Desktop (WSL) environment.
- Run scripts inside WSL/Git Bash to avoid CRLF issues with generated secret files.

## Ports (defaults)
- Masternode P2P: `7447`
- Masternode RPC: `8000` (only exposed on host in local mode)
- Explorer UI: `2750`

## Troubleshooting & tips
- If healthchecks fail, inspect logs:
  - `docker compose logs --tail=200 masternode`
  - `docker compose logs --tail=200 explorer`
- Explorer needs RPC connectivity to the masternode. Ensure `RPC_ALLOWIP` and `RPC_HOST` are set correctly for your environment.
- When running on a host and wanting browser access to RPC, set `RPC_HOST=localhost` in `.env` (local dev). For production leave `RPC_HOST` as the service name and do NOT expose RPC to the public internet.

## Files of interest
- Compose: `docker-compose.yaml`
- Setup helper: `scripts/setup.sh`
- Smoke test: `scripts/smoke-test.sh`
- Master entrypoint: `master/entrypoint.sh`
- Base helpers: `base/mc-common.sh`

## License
- MIT — see `LICENSE`

---

If you want additional sections (examples, CI integration, production hardening) tell me which to add and I will extend the README.
